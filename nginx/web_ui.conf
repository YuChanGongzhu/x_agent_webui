# ====================================
#  Web UI å‰ç«¯æœåŠ¡çš„ Nginx é…ç½®
# ====================================

# ä¸»è¦åŠŸèƒ½:
#   1. é…ç½®åŸŸåå’ŒSSLè¯ä¹¦
#   2. HTTP è‡ªåŠ¨è·³è½¬ HTTPS  
#   3. è´Ÿè½½å‡è¡¡è½¬å‘åˆ°åç«¯æœåŠ¡
#   4. å®‰å…¨ç›¸å…³é…ç½®(SSL/TLS)
# ====================================

# å…¨å±€å‚æ•° - è¿æ¥ç¨³å®šæ€§
client_max_body_size 50m;
client_body_buffer_size 16k;
client_body_timeout 60s;
client_header_timeout 60s;
send_timeout 60s;

# é™åˆ¶æ¯ä¸ªIPçš„è¿æ¥æ•°
limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:10m;
limit_conn conn_limit_per_ip 20;
limit_conn_status 429;

# åç«¯æœåŠ¡å™¨å®šä¹‰
upstream web_backend {
    server 127.0.0.1:3000 max_fails=3 fail_timeout=30s;
    keepalive 64; # å¢åŠ ä¿æŒè¿æ¥æ± å¤§å°
    keepalive_requests 1000; # æ¯ä¸ªä¿æŒè¿æ¥çš„è¯·æ±‚æ•°é‡ä¸Šé™
}

# HTTP é‡å®šå‘åˆ° HTTPS
server {
    listen 80;
    server_name _;

    # å°†æ‰€æœ‰HTTPè¯·æ±‚é‡å®šå‘åˆ°HTTPS
    location /webui {
        return 301 https://$host$request_uri;
    }
    
    # å¥åº·æ£€æŸ¥
    location /health {
        return 200 "healthy\n";
    }
}

# HTTPS æœåŠ¡
server {
    listen 443 ssl;
    server_name _;

    # SSL é…ç½®
    ssl_certificate /etc/letsencrypt/live/lucyai.sale/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/lucyai.sale/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;
    ssl_buffer_size 16k;
    
    # ä¼˜åŒ–é‡ç”¨SSLä¼šè¯
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # HSTSé…ç½® (HTTPä¸¥æ ¼ä¼ è¾“å®‰å…¨)
    add_header Strict-Transport-Security "max-age=63072000" always;
    
    # å¥åº·æ£€æŸ¥ç«¯ç‚¹
    location /health {
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # ä»£ç†åˆ°åç«¯æœåŠ¡
    location /webui {
        proxy_pass http://web_backend;
        rewrite ^/webui(/.*)$ $1 break;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # æ‹¦æˆªåç«¯é”™è¯¯ï¼Œä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯é¡µé¢
        proxy_intercept_errors on;
        error_page 502 503 504 =200 /maintenance.html;
        
        # WebSocketæ”¯æŒ
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # è¶…æ—¶è®¾ç½®
        proxy_connect_timeout 180s;
        proxy_read_timeout 600s;
        proxy_send_timeout 180s;
        
        # ç¼“å†²åŒºè®¾ç½®
        proxy_buffering on;
        proxy_buffer_size 32k;
        proxy_buffers 8 32k;
        proxy_busy_buffers_size 128k;
        
        # é”™è¯¯å¤„ç†
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
    }
    
    # ç³»ç»Ÿç»´æŠ¤é¡µé¢
    location = /maintenance.html {
        root /usr/share/nginx/html;
        internal;
        default_type text/html;
        return 200 '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>ç³»ç»Ÿç»´æŠ¤</title><style>body{font-family:Arial,sans-serif;text-align:center;padding-top:100px;background-color:#f7f7f7;} h1{color:#444;} p{color:#666;} .email{margin-top:30px;font-size:14px;color:#888;}</style></head><body><h1>ğŸ› ï¸ ç³»ç»Ÿå‡çº§ä¸­ ğŸ”§</h1><p>â³ æˆ‘ä»¬æ­£åœ¨è¿›è¡Œç³»ç»Ÿç»´æŠ¤ï¼Œè¯·ç¨åå†è¯•ã€‚ âš™ï¸</p><p>ğŸš§ æ„Ÿè°¢æ‚¨çš„è€å¿ƒç­‰å¾…ï¼ ğŸš§</p><p class="email">ğŸ“§ å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ç®¡ç†å‘˜</p></body></html>';
    }
}